# ğŸ› ï¸ CONTEXT
â€¢ Node/Express backend with tables `councilParticipants` + `councilSessions`.
â€¢ React 18 + React-Query frontend (list key = ['council-bookings']).
â€¢ Need to:   1) cancel a council session   2) refresh Upcoming tab.
â€¢ Previous bug:   ReferenceError: db is not defined  (cancel route).

# ğŸ”§ DO ALL OF THIS

â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
1ï¸âƒ£  BACKEND  (routes/council/cancelSession.ts)
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
```ts
// ğŸ‘‰  Make sure `db` import exists at top of file
import { db } from '../lib/db'               // adjust path to your project

import { eq } from 'drizzle-orm';            // if you use drizzle
import { councilParticipants, councilSessions } from '../schema'; // adjust

export const addCancelRoute = (app, requireAuth) => {
  // PATCH /api/council-sessions/:participantId/cancel
  app.patch('/api/council-sessions/:participantId/cancel', requireAuth, async (req, res) => {
    try {
      const participantId = Number(req.params.participantId);
      const { id: userId } = req.user as any;

      // 1. Join participant + session
      const record = await db.select({
        participantId: councilParticipants.id,
        menteeId: councilParticipants.menteeId,
        sessionId: councilSessions.id,
      })
      .from(councilParticipants)
      .innerJoin(councilSessions, eq(councilParticipants.councilSessionId, councilSessions.id))
      .where(eq(councilParticipants.id, participantId))
      .limit(1)
      .then(r => r[0]);

      if (!record) return res.status(404).json({ message: 'Not found' });
      if (record.menteeId !== userId) return res.status(403).json({ message: 'Forbidden' });

      // 2. Soft-cancel in one transaction
      await db.transaction(async trx => {
        await trx.update(councilParticipants)
          .set({ status: 'cancelled' })
          .where(eq(councilParticipants.id, participantId));

        await trx.update(councilSessions)
          .set({ status: 'cancelled' })
          .where(eq(councilSessions.id, record.sessionId));
      });

      res.json({ success: true, participantId });
    } catch (e) {
      console.error('Cancel error', e);
      res.status(500).json({ message: 'Cancel failed' });
    }
  });
};

â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
2ï¸âƒ£  FRONTEND  (useMutation)
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
```ts
const { mutate: cancelCouncilSession } = useMutation({
  mutationFn: async (participantId: number) => {
    const res = await fetch(`/api/council-sessions/${participantId}/cancel`, { method: 'PATCH' });
    const json = await res.json();
    if (!res.ok) throw new Error(json.message || 'Cancel failed');
    return json;
  },
  onSuccess: async () => {
    toast({ title: 'Session cancelled' });
    await queryClient.invalidateQueries({ queryKey: ['council-bookings'] }); // key must match list
  },
});

<Button variant="destructive" onClick={() => cancelCouncilSession(participantId)}>
  Cancel
</Button>

â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
3ï¸âƒ£  OPTIONAL DB CONSTRAINT (one per month)
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
```sql
ALTER TABLE council_sessions
ADD CONSTRAINT uniq_user_month
UNIQUE (user_id, date_trunc('month', scheduled_date));


â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
4ï¸âƒ£  VERIFICATION CHECKLIST
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
âœ“ Book a session â†’ appears in Upcoming  
âœ“ Click Cancel â†’ toast â€œSession cancelledâ€  
âœ“ Upcoming list refreshes (no manual reload)  
âœ“ GET /api/council-bookings returns status = "cancelled" or row hidden by filter  
âœ“ DB shows both participant & session rows status = cancelled  
âœ“ Booking another session in same month now succeeds  
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

Run through the checklist.
	â€¢	If POST succeeds but Cancel 500s, re-check the db import path.
	â€¢	If Cancel works but list doesnâ€™t refresh, verify React-Query key matches exactly (['council-bookings']).
	â€¢	If UI still shows cancelled rows, filter status !== 'cancelled' in list view.

Stop only when every checklist item passes.